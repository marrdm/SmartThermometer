/*
===============================================================================
 Name        : Software.c
 Author      : $(author)
 Version     :
 Copyright   : $(copyright)
 Description : main definition
===============================================================================
*/

#include "Software.h"

// TODO: insert other include files here

// TODO: insert other definitions and declarations here
void cycle_colour();

float voltage = 0;								//global variables for calculating average voltage
int temp = 0;
int k = 0;
int sum = 0;

void TIMER32_0_IRQHandler (void);
void UART_IRQHandler (void);
void PIOINT1_IRQHandler (void);
void ADC_IRQHandler (void);

int main(void) {


	LPC_IOCON->R_PIO1_2 = 1;
	LPC_IOCON->R_PIO0_11 = 1;
	LPC_GPIO1->DIR |= (1<<2);
	LPC_GPIO0->DIR |= (1<<11);
												//button initialization code
	LPC_GPIO1->DIR &= ~(1<<4);
	LPC_GPIO1->IS &= ~(1<<4);					//edge sensitive
	LPC_GPIO1->IBE &= ~(1<<4);					// trigger interrupt only on one edge
	LPC_GPIO1->IEV &= ~(1<<4);					//trigger on falling edge
	LPC_GPIO1->IE |= (1<<4);					//enable interrupt

	LPC_GPIO2->DIR |= (1<<6);					//ADC set up code
	LPC_GPIO2->DATA |= (1<<6);
	LPC_IOCON->PIO1_11 |= 1;					//table 94
	LPC_IOCON->PIO1_11 &= ~(1<<7);
	LPC_SYSCON->SYSAHBCLKCTRL |= (1<<13);
	LPC_ADC->CR |= (1<<7)|(10<<8);				//channel 7, software controlled, 4.36MHz
	LPC_SYSCON->PDRUNCFG &= ~(1<<4);			//ADC powered up
	LPC_ADC->INTEN |= (1<<7);					//channel 7 interrupt enabled

	pwm_init();

	__disable_irq();
	NVIC_SetPriority(TIMER_32_0_IRQn, 0);		//enable timer interrupt
	NVIC_EnableIRQ(TIMER_32_0_IRQn);
	NVIC_SetPriority(UART_IRQn, 0);				//enable UART interrupt
	NVIC_EnableIRQ(UART_IRQn);
	NVIC_SetPriority(UART_IRQn, 0);				//enable UART interrupt
	NVIC_EnableIRQ(UART_IRQn);
	NVIC_SetPriority(EINT1_IRQn, 0);			//enable external interrupt
	NVIC_EnableIRQ(EINT1_IRQn);
	NVIC_SetPriority(ADC_IRQn, 0);					//enable ADC interrupt
	NVIC_EnableIRQ(ADC_IRQn);
	__enable_irq();								//enable all interrupts

    while(1) {
    	int i = 0;
    	while(i<10000){
    		i++;
    	}
    	cycle_colour();
    }
    return 0 ;
}

void cycle_colour(){
	static int colour = 255;
	static int colour_inc = 1;

	colour += colour_inc;
	pwm_red(colour - 255);
	pwm_blue(255 - colour);
	pwm_green(255 - (colour/2));

	if(colour > 511 || colour <= 0){
		colour_inc = - colour_inc;
	}
}

void TIMER32_0_IRQHandler (void){
	LPC_TMR32B0->IR = 1;
	LPC_ADC->CR |= (1<<24);	//start AD conversion

}

void UART_IRQHandler (void){
	char c = 0;
	c = LPC_UART->RBR;
    LPC_UART->THR = c;
    while(!(LPC_UART->LSR & (1<<5)));

    if(c == '\r'){
    	LPC_UART->THR = '\n';
    	while(!(LPC_UART->LSR & (1<<5)));
    	parser(string, i);
    	i = 0;
    }
}

void PIOINT1_IRQHandler (void){
	 LPC_GPIO1->IC |= (1<<4);

}

void ADC_IRQHandler (void){
	int temp = 0;
	LPC_ADC->INTEN = 0;							//reset interrupt
	temp = LPC_ADC->GDR;
	temp = temp & (0x3ff<<6);
	temp = temp>>6;
	sum = sum + temp;
	if(k<1000){
	LPC_ADC->CR |= (1<<24);						//start conversion
	k++;
	}
	else {
	k = 0;
	voltage = sum/10000;
    voltage /= 287;
    sum = 0;
    k = 0;
	}
}



