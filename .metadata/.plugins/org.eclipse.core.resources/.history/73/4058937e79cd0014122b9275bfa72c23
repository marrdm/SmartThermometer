/*
 * uart.c
 *
 *  Created on: 13 Mar 2015
 *      Author: Marcus
 */

#define UART_TX_BUB_SIZE 32
int uart_tx_buf_start = 0;
int uart_tx_buf_end = 0;
char uart_tx_buf[UART_TX_BUB_SIZE];

int uart_tx_active = 0;

void uart_init(){

}

int uart_send(char str[], int len){
/*
 * Return value n > 0 indicates a buffer overflow where n is the number of characters not entered into the buffer.
 */
	int i = 0;
	while(i < len){

		if( ((uart_tx_buf_end + 1) == uart_tx_buf_start) ||
				( (uart_tx_buf_end == (UART_TX_BUB_SIZE - 1) && (uart_tx_buf_start == 0) ))){
			break;									// Buffer full
		}
		if(uart_tx_buf_end == (UART_TX_BUB_SIZE - 1) ){
			uart_tx_buf_end = 0;
		}else{
			uart_tx_buf_end++;
		}

		uart_tx_buf[uart_tx_buf_end] = str[i];
		i++;

	}

	if(!uart_tx_active){
		uart_transmit();
	}
	return (len - i);
}

void uart_transmit(){
	if(uart_tx_buf_end == uart_tx_buf_start){
		uart_tx_active = 0;
		return;
	}

}

void UART_IRQHandler (void){
	char c = 0;
	c = LPC_UART->RBR;
    LPC_UART->THR = c;
    while(!(LPC_UART->LSR & (1<<5)));

    if(i < 16){
    	string[i] = c;
    }
    i++;
    if(c == '\r'){
    	LPC_UART->THR = '\n';
    	while(!(LPC_UART->LSR & (1<<5)));
    	parser(string, i);
    	i = 0;
    }
}
